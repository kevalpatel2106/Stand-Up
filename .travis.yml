language: android
jdk: oraclejdk8
sudo: required
dist: precise

notifications:
  slack:
    secure: VoNMKOrdHjRhUxErEwzbymPbKxvtz3Mf9Gw3cEnH0F/wOD+dZlY2cCsLs/gSWfEgjBzUsziwKnkdo3s8jGQjTiKps6eVT7Ufae/VJyCOzF9m60UQAvNsqdHQO71QhOGh9WBvgf2IfTi7U0M+rblBaajqfmIQEsS+I41pbaXwE0ZciH9cekwtNqd+zKxYCipKpl4xKh3PJdrA3Dac2zHOObq1AyJ39eTDclx0//+5p4gPW/awcZxzwagu712Mjd8TCUFQ7j8q4iBppil7DnthmJ6CwQzqavTBekpQuOTWBCEEoOr5kkpj3290Y0EsCNwj+o8t2HvBWhkizNLKjx07PUDYhYHNrBev7zKg0TFoMPaYVx8r6uiYT6XESQFjc/pL5pBpQzj+RlPahSb82wfdKBTXX0mIjayHLM4Yyh6n9pJTxADXfwl/k21T7mb7FyXaCXipSIL8EwV+3uMlF3LXy05VQIJCUmk7Z8PZ1mGsVzA7swCRgyh/EoGXRp070odMKVJKAeqppELw5IOkLdF5rrPXShsVzQpbPThtjVirHaaetf5mdxDCk2BrczBwzRrJpKNxesXuPjibdh7FLgkl5X9PNJG7LqeEukgboRmvJNppe1Jgpzh8iZoGx7eFhQkzfKq84Igkf+owsMyvtamFTG4hfuJu5R9gk1rIqmbikNg=
  email: false

env:
  global:
    - ANDROID_TARGET=android-21
    - ANDROID_ABI=armeabi-v7a
    - ADB_INSTALL_TIMEOUT=10
    - secure: "rYeWDqlP8GXcoHHriPmnQRQ5bwOtVU8XBk4SzLuCXEVn8TwrTyfegJYk9TqrK4Mg3U8iaX9H+DTzYvrBU9XfiQHnXqAk+MUkEmpxSW1f5o27ZMEq4nwKgBtyv/BzYm7996xujOEFavNBSPKF4sRARzGJVOV638lLJg+53lvqUSwn7tsasfTJsCGNdMV0oeBKJzFu3ufh/6gEak5YjeGMhEYogIEctadgpuXVtAzzHnXKNwj1b+oCSovPkHIHSzRw2GnhdcyLsqIFnbKXg6L6LSK2/63htRIn0cDZd4SCyJ0ldBojoDejoiU97nnNNxrGJt7IVRRSFEtEYsIZTJUl0rHdzu+iwcAeWtvZkpE2gcqSIloALNCqbMu+vaf0TZ2ylC9T2GuNDPj66rt5e4jFHZUaEdEudo84hKZalw9cX1UTzU0kGavxQqshA1HyE9BcMaOtOfCQmU+4T2o4yGJJGFW8CO2Awezsq2iP7cQWLin3nqvrT0Yrh9tqIpS7si1f+ctp6WC4fCkuT3ajz8Vu/YKoNIPgjk1ZLeAUUl4v1qkFLdf8VKHhMLNpCFdFCoNOB1D25aZSYQZWhEcKlt9bKQqLy7Nt7f30c6effi5w01r0I5VjSU+bGgyWBDuoyPG7BwQx0nWjBFyImQj3mbn68ZbWaNl1WIu4HPXW27zlASc="

before_install:
  # Set encrypted files
  - openssl aes-256-cbc -K $encrypted_3d33edd66e0c_key -iv $encrypted_3d33edd66e0c_iv -in misc/secrets.tar.enc -out secrets.tar -d
  - tar xvf secrets.tar
  - mv google-services.json ./app
  - mv keystore.jks ./misc

  # Install npm
  - curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.3/install.sh | bash
  - npm install -g cloc

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -f  $HOME/.gradle/caches/transforms-1/transforms-1.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - "$HOME/.gradle/caches/"
    - "$HOME/.gradle/wrapper/"
    - "$HOME/.android/build-cache"

android:
  components:
    - platform-tools
    - tools
    - build-tools-27.0.2
    - android-26
    - extra-google-m2repository
    - extra-android-m2repository

    #system images
    - sys-img-${ANDROID_ABI}-${ANDROID_TARGET}
  licenses:
    - android-sdk-preview-license-.+
    - android-sdk-license-.+
    - google-gdk-license-.+

before_script:
  - chmod +x gradlew
  - chmod +x ./scripts/set_emulator_prop.sh

  - cloc . 2> ./cloc.txt

  - android list targets

  # Create emulator
  - echo no | android create avd --force --name test -t $ANDROID_TARGET --abi $ANDROID_ABI -d "Nexus 6"
  - bash ./scripts/set_emulator_prop.sh

  # Start emulator
  - emulator -avd test -no-skin -no-audio -no-window &
  - android-wait-for-emulator

  - adb devices   #Display list of devices
  - adb shell settings put global window_animation_scale 0.0â€¨
  - adb shell settings put global transition_animation_scale 0.0
  - adb shell settings put global animator_duration_scale 0.0
  - adb shell input keyevent 82 &

script:
  - ./gradlew jacocoTestReportDebug connectedCheck app:assembleDebug -PdisablePreDex --continue --profile --daemon --parallel

  - if [ "$TRAVIS_EVENT_TYPE" == "cron" ]; then
      chmod +x ./scripts/dependency_check.sh
      bash ./scripts/dependency_check.sh

      ./gradlew lintRelease app:assembleRelease -PdisablePreDex --continue --profile --daemon --parallel
    fi

after_success:
  - bash <(curl -s https://codecov.io/bash)

  - chmod +x ./scripts/upload-artifacts.sh
  - bash ./scripts/upload-artifacts.sh

after_failure:
  - chmod +x ./scripts/upload-artifacts.sh
  - bash ./scripts/upload-artifacts.sh
